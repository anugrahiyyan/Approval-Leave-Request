<!DOCTYPE html>
<html>

<head>
  <!--
    Creator: Galbatorix
    Created for ONEderland Leave Request System
    If you need support, improvements, or bug fixes, please contact the creator.

    Version: 16
    Date: September 13, 2025
  -->
  <base target="_top">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" sizes="16x16 32x32 48x48"
    href="https://cloudserver.satuimpianbersama.com/apps/theming/favicon/dashboard" type="image/x-icon" />
  <style>
    body {
      padding: 2rem;
      font-family: "Inter", system-ui, sans-serif;
    }

    /* Background video + overlay */
    #bg-video {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -3;
    }

    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      z-index: -2;
    }

    /* Form container */
    .form-wrapper {
      max-width: 950px;
      margin: auto;
      padding: 2.5rem;
      background: rgba(255, 255, 255, 0.93);
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(8px);
    }

    /* Typography */
    .title-text {
      font-weight: 600;
      font-size: 26px;
      margin-bottom: .5rem;
    }

    .subtitle-text {
      font-size: 14px;
      opacity: .7;
    }

    /* Buttons & Inputs */
    .form-control,
    .btn-light,
    .btn-primary {
      border-radius: 10px;
      padding: 10px 14px;
    }

    .btn-primary {
      font-size: 18px;
      padding: 12px;
    }

    /* Dropdown behavior */
    .dropdown-toggle {
      text-align: left;
    }

    .dropdown-item {
      transition: background .2s ease;
    }

    .dropdown-item:hover {
      background: #1375d7 !important;
      color: #fff !important;
    }

    /* Error field */
    .is-invalid {
      border-color: #dc3545 !important;
      background: #ffe6e6 !important;
    }

    /* Utility + layout */
    .top-right-login {
      position: absolute;
      top: 22px;
      right: 22px;
      display: flex;
      gap: 10px;
    }

    .footer-overlay {
      background: rgba(0, 0, 0, 0.6);
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .form-wrapper {
        padding: 1.5rem;
      }

      textarea {
        height: 120px !important;
      }
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 14px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-left: 1px solid #ddd;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #00d2ff 0%, #3a7bd5 100%);
      /* Blue Sea Gradient */
      border-radius: 10px;
      border: 3px solid transparent;
      background-clip: content-box;
    }

    ::-webkit-scrollbar-thumb:hover {
      background-color: #0099cc;
    }

    /* Running Text Sidebar */
    .running-text-sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: 24px;
      /* Slightly wider than scrollbar to sit next to or under it? */
      height: 100vh;
      background: #2c3e50;
      /* Cyber dark background */
      z-index: 9999;
      /* Top most, but wait, scrollbar controls are z-index max usually. */
      /* If we want it ON the scrollbar, we can't because it will block clicks. 
         Let's put it slightly to the LEFT of the scrollbar if possible, or just accept it's decorative.
         Actually, user wants "running text IN that scroll bar". 
         Best bet: standard scrollbar is on the right functionality. 
         This sidebar sits adjacent to it (right: 0) but pointer-events: none so scroll still works? 
         If standard scrollbar is visible, it takes up space. 
         Let's try overlaying it or putting it just to the left. 
         Actually, let's try pointer-events: none and mix-blend-mode.
      */
      pointer-events: none;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      color: rgba(255, 255, 255, 0.5);
      font-size: 12px;
      letter-spacing: 3px;
      font-family: 'Courier New', monospace;
      font-weight: bold;

      /* Hide on mobile */
      display: none;
    }

    @media (min-width: 992px) {
      .running-text-sidebar {
        display: flex;
        /* Position it just to the left of the scrollbar (width 14px) */
        right: 14px;
      }
    }

    .marquee-content {
      animation: scrollText 15s linear infinite;
      white-space: nowrap;
    }

    @keyframes scrollText {
      0% {
        transform: translateY(100%);
      }

      100% {
        transform: translateY(-100%);
      }
    }
  </style>

<body>

  <!-- Decorative Running Text Sidebar -->
  <div class="running-text-sidebar">
    <div class="marquee-content">
      ONEderland Leaveform &nbsp;&bull;&nbsp; ONEderland Leaveform &nbsp;&bull;&nbsp; ONEderland Leaveform
      &nbsp;&bull;&nbsp;
    </div>
  </div>

  <!-- Background Video -->
  <video autoplay muted loop playsinline id="bg-video">
    <source src="https://leaveform.satuimpianbersama.com/bgmv/bg_Underground_Cave_1920x1080.mp4" type="video/mp4">
  </video>
  <div id="overlay"></div>

  <!-- Hidden YouTube Player -->
  <div id="musicPlayer" style="display:none;"></div>

  <!-- Logo -->
  <div class="text-center mb-4">
    <img src="https://leaveform.satuimpianbersama.com/images/oe-logo.png" width="400" class="img-fluid"
      alt="ONEderland Enterprise Logo" />
  </div>

  <!-- Main Form Container -->
  <form id="leaveForm">
    <div class="container-lg form-wrapper p-4">

      <div class="row">
        <!-- User Info Section -->
        <div class="row mb-4">
          <div class="col-md-4 mb-3">
            <label class="form-label">Full Name</label>
            <input type="text" id="name" placeholder="Name" class="form-control"
              value="<?= detectedName ? detectedName : '' ?>" required>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Email</label>
            <input type="email" id="email" placeholder="Email" class="form-control"
              value="<?= detectedEmail ? detectedEmail : '' ?>" <?=detectedEmail
              ? 'readonly style="background-color:#e9ecef;"' : '' ?> required>
            <? if (detectedEmail) { ?>
            <small class="text-muted" style="font-size:0.75rem;">Auto-detected</small>
            <? } ?>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Department</label>
            <div class="dropdown w-100">
              <button class="btn btn-light dropdown-toggle w-100 d-flex justify-content-between align-items-center"
                type="button" id="departmentDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <span id="departmentText">Select</span>
              </button>
              <ul class="dropdown-menu w-100">
                <li><a class="dropdown-item dept-option" data-value="Carbon Energy">Carbon Energy</a></li>
                <li><a class="dropdown-item dept-option" data-value="Education ONE">Education ONE</a></li>
                <li><a class="dropdown-item dept-option" data-value="English Cafe">English Cafe</a></li>
                <li><a class="dropdown-item dept-option" data-value="General Manager">General Manager</a></li>
                <li><a class="dropdown-item dept-option" data-value="Neurone Recruitment">Neurone Recruitment</a></li>
                <li><a class="dropdown-item dept-option" data-value="ONEderland Consulting">ONEderland Consulting</a>
                </li>
                <li><a class="dropdown-item dept-option" data-value="ONEderland Enterprise Finance">ONEderland
                    Enterprise Finance</a></li>
                <li><a class="dropdown-item dept-option" data-value="ONEderland Enterprise HRGA">ONEderland Enterprise
                    HRGA</a></li>
                <li><a class="dropdown-item dept-option" data-value="PeraONE Xperience">PeraONE Xperience</a></li>
                <li><a class="dropdown-item dept-option" data-value="SnG OE">SnG OE</a></li>
              </ul>
            </div>
            <input type="hidden" id="department" required>
          </div>
        </div>

        <hr class="mb-4">

        <!-- Leave Requests Container -->
        <div id="leave-requests-container">
          <!-- Dynamic Items will be added here -->
        </div>

        <!-- Add Button & Totals -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <button type="button" class="btn btn-outline-primary btn-sm" id="addLeaveBtn">
            <span class="me-1">+</span> Add Another Leave
          </button>
          <div class="text-end">
            <span class="text-muted me-2">Total Estimated Days:</span>
            <span class="fw-bold fs-5 text-primary" id="grandTotalDays">0</span>
          </div>
        </div>

        <!-- Global Attachment (Hidden by default) -->
        <div class="mb-3" id="attachmentDiv" style="display:none;">
          <label class="form-label text-danger fw-bold">
            Medical Certificate / Document
            <span id="helpIcon2" class="ms-1" style="cursor:pointer; color:#6c757d;" data-bs-toggle="popover"
              title="Requirement" data-bs-content="Required for Sick Leave or unpaid leave evidence.">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                class="bi bi-question-circle" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                <path
                  d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z" />
              </svg>
            </span>
          </label>
          <input type="file" id="attachment" class="form-control" accept="image/*,.pdf">
          <small class="text-muted">Required for Sick Leave. Max 5MB.</small>
        </div>
      </div>

      <div class="d-flex flex-column flex-md-row justify-content-center gap-3 mt-4">
        <button type="button" id="checkBalanceBtn" class="btn btn-primary px-5 py-2">Check Balance</button>
        <button type="submit" id="submitBtn" class="btn btn-primary px-5 py-2">Submit Form</button>
      </div>
    </div>
  </form>

  <!-- Loading Spinner -->
  <div id="loadingScreen"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; text-align:center; padding-top:200px;">
    <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
      <span class="visually-hidden">Submitting...</span>
    </div>
    <p style="margin-top:20px; font-size:18px;">Submitting your request...</p>
  </div>

  <!-- Bootstrap Modal for Result -->
  <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="resultModalLabel">Submission Result</h5>
        </div>
        <div class="modal-body" id="resultModalBody">
          <!-- This will be filled dynamically -->
        </div>
        <div class="modal-footer" id="resultModalFooter">
          <button type="button" class="btn btn-primary" id="closeModalBtn" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- <button id="toggleMusic" class="btn btn-secondary"
      style="position:fixed; bottom:20px; right:20px; z-index:999;">ðŸ”ˆ
    </button> -->

  <!-- Footer -->
  <footer class="footer-overlay text-light small text-center rounded-3 px-4 py-3 mt-5 mx-auto" style="max-width:400px;">
    Â© ONEderland Enterprise <span id="footerYear"></span> â€” v4.1.12012026
    <br>
    <a href="https://leaveform.satuimpianbersama.com/privacy-policy.html" target="_blank" rel="noopener noreferrer"
      class="text-light text-decoration-underline">Privacy Policy</a> |
    <a href="https://leaveform.satuimpianbersama.com/tos.html" target="_blank" rel="noopener noreferrer"
      class="text-light text-decoration-underline">Terms of Service</a>
  </footer>
</body>


<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/tsparticles@2/tsparticles.bundle.min.js"></script>

<script>
  function escapeHtml(text) {
    if (!text) return text;
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  document.getElementById("footerYear").textContent = new Date().getFullYear();

  // --- Dynamic Leave Request Logic ---
  let leaveRequestIndex = 0;
  const leaveContainer = document.getElementById("leave-requests-container");
  const grandTotalEl = document.getElementById("grandTotalDays");

  // Helper: Parse DMY to Date
  function parseDMY(dmy) {
    if (!dmy) return null;
    const [day, month, year] = dmy.split('-').map(Number);
    return new Date(year, month - 1, day);
  }

  // Initial Add
  addLeaveRequest();

  document.getElementById("addLeaveBtn").addEventListener("click", () => {
    addLeaveRequest();
  });

  function addLeaveRequest() {
    const i = leaveRequestIndex++;
    const div = document.createElement("div");
    div.className = "leave-item card p-3 mb-3 border shadow-sm position-relative";
    div.id = `leaveItem_${i}`;
    div.innerHTML = `
      ${i > 0 ? `<button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Remove" onclick="removeLeaveRequest(${i})"></button>` : ''}
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label fw-bold">Leave Type</label>
          <div class="input-group">
            <select class="form-select leave-type-select" id="leaveType_${i}" onchange="onLeaveTypeChange(${i})">
              <option value="" selected disabled>Select Type...</option>
              <option value="Annual Leave">Annual Leave</option>
              <option value="Bereavement Leave">Bereavement Leave</option>
              <option value="Career Leave">Career Leave</option>
              <option value="Ceremony Leave">Ceremony Leave</option>
              <option value="Marriage Leave">Marriage Leave</option>
              <option value="Maternity Leave">Maternity Leave</option>
              <option value="Sick Leave">Sick Leave</option>
              <option value="Unpaid Leave - FT">Unpaid Leave - FT</option>
              <option value="Unpaid Leave - ITN">Unpaid Leave - ITN</option>
              <option value="Working From Home (WFH)">Working From Home (WFH)</option>
              <option value="Other">Other</option>
            </select>
            
            <div class="input-group-text bg-white">
              <input class="form-check-input mt-0 me-1" type="checkbox" id="halfDay_${i}" onchange="onHalfDayChange(${i})">
              <label class="form-check-label small mb-0" for="halfDay_${i}">Half-Day</label>
            </div>
          </div>

          <div class="mt-3">
             <label class="form-label fw-bold">Reason</label>
             <textarea id="reason_${i}" placeholder="You can write your message here" class="form-control" rows="4" required
              oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="row">
            <div class="col-6">
              <label class="form-label fw-bold">Start Date</label>
              <input type="text" class="form-control date-input" id="startDate_${i}" placeholder="mm-dd-yyyy">
            </div>  
            <div class="col-6" id="endDateContainer_${i}">
              <label class="form-label fw-bold">End Date</label>
              <input type="text" class="form-control date-input" id="endDate_${i}" placeholder="mm-dd-yyyy" onchange="calculateItemDays(${i})">
            </div>
          </div>

          <!-- Per-Row Attachment (Hidden by default) -->
          <div class="mt-3" id="attachmentDiv_${i}" style="display:none;">
            <label class="form-label text-danger fw-bold small">
              <i class="bi bi-paperclip"></i> Medical Certificate (Required for Sick Leave)
            </label>
            <input type="file" id="attachment_${i}" class="form-control form-control-sm" accept="image/*,.pdf">
          </div>
          
          <input type="hidden" id="daysCount_${i}">
        </div>
      </div>
    `;

    leaveContainer.appendChild(div);

    // Init Flatpickr
    const commonConfig = {
      dateFormat: "d-m-Y",
      altInput: true,
      altFormat: "F j, Y",
      onChange: () => calculateItemDays(i)
    };

    flatpickr(`#startDate_${i}`, commonConfig);
    flatpickr(`#endDate_${i}`, commonConfig);
  }

  function removeLeaveRequest(id) {
    const el = document.getElementById(`leaveItem_${id}`);
    if (el) {
      el.remove();
      calculateGrandTotal();
      checkGlobalAttachmentRequirement();
    }
  }

  window.removeLeaveRequest = removeLeaveRequest; // Expose to global for onclick

  function onHalfDayChange(i) {
    const isHalf = document.getElementById(`halfDay_${i}`).checked;
    const endContainer = document.getElementById(`endDateContainer_${i}`);

    if (isHalf) {
      // Hide end date, sync it with start date logic handled in calc
      endContainer.style.opacity = "0.5";
      endContainer.style.pointerEvents = "none";
      document.getElementById(`endDate_${i}`).value = document.getElementById(`startDate_${i}`).value;
    } else {
      endContainer.style.opacity = "1";
      endContainer.style.pointerEvents = "auto";
    }
    calculateItemDays(i);
  }
  window.onHalfDayChange = onHalfDayChange;

  function onLeaveTypeChange(i) {
    toggleRowAttachment(i);
  }
  window.onLeaveTypeChange = onLeaveTypeChange;

  function toggleRowAttachment(i) {
    const val = document.getElementById(`leaveType_${i}`).value;
    const attachmentDiv = document.getElementById(`attachmentDiv_${i}`);
    const attachmentInput = document.getElementById(`attachment_${i}`);

    if (val === 'Sick Leave') {
      attachmentDiv.style.display = "block";
      // We don't force 'required' attribute strictly because we check manually on submit
    } else {
      attachmentDiv.style.display = "none";
      attachmentInput.value = ''; // Clear file if type changes
    }
  }

  function calculateItemDays(i) {
    const isHalf = document.getElementById(`halfDay_${i}`).checked;
    const startVal = document.getElementById(`startDate_${i}`).value;
    const endVal = document.getElementById(`endDate_${i}`).value;

    if (!startVal) return;

    // specific half day logic
    if (isHalf) {
      document.getElementById(`daysCount_${i}`).value = 0.5;
      calculateGrandTotal();
      return;
    }

    if (!endVal) return;

    const start = parseDMY(startVal);
    const end = parseDMY(endVal);

    if (start > end) {
      // Invalid
      document.getElementById(`daysCount_${i}`).value = 0;
      return;
    }

    let count = 0;
    let curr = new Date(start);
    while (curr <= end) {
      const d = curr.getDay();
      if (d !== 0 && d !== 6) count++;
      curr.setDate(curr.getDate() + 1);
    }
    document.getElementById(`daysCount_${i}`).value = count;
    calculateGrandTotal();
  }

  function calculateGrandTotal() {
    let total = 0;
    document.querySelectorAll('[id^=daysCount_]').forEach(el => {
      total += parseFloat(el.value || 0);
    });
    grandTotalEl.innerText = total;
  }

  // --- Department Dropdown Logic ---
  document.querySelectorAll('.dept-option').forEach(item => {
    item.addEventListener('click', function () {
      const value = this.getAttribute('data-value');
      document.getElementById('departmentText').innerText = value;
      document.getElementById('department').value = value;
    });
  });

  // Optimize Particles for Mobile
  const isMobile = window.innerWidth < 768;
  const particleCount = isMobile ? 30 : 90; // Reduce count significantly on mobile

  tsParticles.load("tsparticles", {
    particles: {
      number: { value: particleCount, density: { enable: true, area: 800 } },
      color: { value: "#fff" },
      shape: { type: "circle" },
      opacity: { value: 0.5 },
      size: { value: { min: 1, max: 3 } },
      links: { enable: true, distance: 200, color: "#fff", opacity: 0.3, width: 1 },
      move: { enable: true, speed: 1, outModes: "out" }
    },
    interactivity: {
      events: {
        onHover: { enable: true, mode: "grab" },
        onClick: { enable: true, mode: "push" }
      },
      modes: {
        grab: { distance: 280, links: { opacity: 0.5 } },
        push: { quantity: 3 }
      }
    },
    detectRetina: true
  });

  // --- Modal Helper ---
  function showModal(title, message, isError = false) {
    const modalEl = document.getElementById("resultModal");
    const modalTitle = document.getElementById("resultModalLabel");
    const modalBody = document.getElementById("resultModalBody");
    const modalFooter = document.getElementById("resultModalFooter");

    // Reset footer to default OK button
    modalFooter.innerHTML = '<button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>';

    modalTitle.innerText = title;
    // Use alert styling for body if error
    if (isError) {
      modalBody.innerHTML = `<div class="alert alert-danger border-0">${message}</div>`;
    } else {
      modalBody.innerHTML = message;
    }

    const modal = new bootstrap.Modal(modalEl);

    // Reload page when modal is closed (hidden) to force reset
    // This addresses the user request: "if close from modal, please reset the form.html"
    modalEl.addEventListener('hidden.bs.modal', function () {
      location.reload();
    });

    modal.show();
  }
  window.showModal = showModal;

  // --- Check Balance Logic ---
  document.getElementById("checkBalanceBtn").addEventListener("click", function () {
    const email = document.getElementById("email").value;
    const resultModal = new bootstrap.Modal(document.getElementById("resultModal"));
    const resultBody = document.getElementById("resultModalBody");

    if (!email) {
      resultBody.innerHTML = '<div class="alert alert-warning">Please enter your email address first.</div>';
      resultModal.show();
      return;
    }

    const btn = this;
    const originalText = btn.innerText;
    btn.disabled = true;
    btn.innerText = "Checking...";

    google.script.run
      .withSuccessHandler((balance) => {
        btn.disabled = false;
        btn.innerText = originalText;
        if (!balance) {
          resultBody.innerHTML = `<div class="alert alert-danger">The email <code>${escapeHtml(email)}</code> is not registered in our system.</div>`;
        } else {
          resultBody.innerHTML = `
            <div class="text-center">
              <h5>Balance for: <strong>${escapeHtml(email)}</strong></h5>
              <hr>
              <ul class="list-group list-group-flush text-start">
                  <li class="list-group-item d-flex justify-content-between"><span>Annual Leave</span> <strong>${balance.annual}</strong></li>
                  <li class="list-group-item d-flex justify-content-between"><span>Sick Leave</span> <strong>${balance.sick}</strong></li>
                  ${parseFloat(balance.bereavement) > 0 ? `<li class="list-group-item d-flex justify-content-between"><span>Bereavement</span> <strong>${balance.bereavement}</strong></li>` : ''}
                  ${parseFloat(balance.marriage) > 0 ? `<li class="list-group-item d-flex justify-content-between"><span>Marriage</span> <strong>${balance.marriage}</strong></li>` : ''}
                  ${parseFloat(balance.maternity) > 0 ? `<li class="list-group-item d-flex justify-content-between"><span>Maternity</span> <strong>${balance.maternity}</strong></li>` : ''}
              </ul>
            </div>`;
        }
        resultModal.show();
      })
      .withFailureHandler((e) => {
        btn.disabled = false;
        btn.innerText = originalText;
        resultBody.innerHTML = `<div class="alert alert-danger">Error: ${e}</div>`;
        resultModal.show();
      })
      .getLeaveBalanceByEmail(email);
  });

  // --- SUBMIT LOGIC ---
  document.getElementById("leaveForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("email").value.trim();
    const department = document.getElementById("department").value;

    if (!name || !email || !department) {
      showModal("Validation Error", "Please fill in Name, Email and Department.", true);
      return;
    }

    // Gather Requests
    const items = document.querySelectorAll('.leave-item');
    const requestsRequests = []; // Renamed to avoid confusion
    let hasSick = false;
    let hasZeroDays = false;
    let usageMap = {};
    let missingFile = false;

    // Helper to add usage
    const addUsage = (type, q) => { usageMap[type] = (usageMap[type] || 0) + q; };

    items.forEach(div => {
      const id = div.id.split('_')[1];
      const type = document.getElementById(`leaveType_${id}`).value;
      const splitType = type.trim(); // Ensure no whitespace issues
      const isHalf = document.getElementById(`halfDay_${id}`).checked;
      const start = document.getElementById(`startDate_${id}`).value;
      // For half day, end = start effectively for processing, but passed as such.
      let end = document.getElementById(`endDate_${id}`).value;
      if (isHalf) end = start;

      const reason = document.getElementById(`reason_${id}`).value.trim();
      const days = parseFloat(document.getElementById(`daysCount_${id}`).value || 0);
      const attachmentInp = document.getElementById(`attachment_${id}`);

      if (!type || !start || !end || !reason) return;
      if (days <= 0 && type !== 'Other') hasZeroDays = true;

      // Check Sick Leave Attachment
      let fileObj = null;
      if (splitType === 'Sick Leave') {
        if (attachmentInp.files.length === 0) {
          missingFile = true;
        } else if (attachmentInp.files[0].size > 5 * 1024 * 1024) {
          showModal("File Too Large", `File for ${splitType} exceeds 5MB.`, true);
          // We can flag error here, but let's just use missingFile to block
          missingFile = true;
        } else {
          fileObj = attachmentInp.files[0];
        }
      }

      requestsRequests.push({
        leaveType: splitType,
        startDate: start,
        endDate: end,
        reason: reason,
        duration: days,
        fileInput: fileObj // Store file object for processing
      });

      addUsage(splitType, days);
    });

    if (requestsRequests.length === 0) {
      showModal("No Requests", "Please add at least one leave request.", true);
      return;
    }

    if (hasZeroDays) {
      showModal("Invalid Duration", "One or more requests have 0 valid days. Please check dates.", true);
      return;
    }

    if (missingFile) {
      showModal("Missing Document", "Medical Certificate is required for all Sick Leave requests (Max 5MB).", true);
      return;
    }

    const submitBtn = document.getElementById("submitBtn");
    const loadingScreen = document.getElementById("loadingScreen");
    const resultModal = new bootstrap.Modal(document.getElementById("resultModal"));
    const resultBody = document.getElementById("resultModalBody");
    const modalFooter = document.getElementById("resultModalFooter");

    submitBtn.disabled = true;
    loadingScreen.style.display = "block";

    // Validate Balance and Submit
    google.script.run
      .withSuccessHandler((balance) => {
        if (!balance) {
          loadingScreen.style.display = "none";
          submitBtn.disabled = false;
          showModal("Email Not Found", `The email ${escapeHtml(email)} is not registered in our system.`, true);
          return;
        }

        // Check each usage against balance
        let errorMsg = "";
        const balanceMap = {
          'Annual Leave': 'annual',
          'Sick Leave': 'sick',
          'Bereavement Leave': 'bereavement',
          'Marriage Leave': 'marriage',
          'Maternity Leave': 'maternity'
        };

        for (const [lType, daysNeeded] of Object.entries(usageMap)) {
          const key = balanceMap[lType];
          if (key) {
            const available = balance[key] || 0;
            if (daysNeeded > available) {
              errorMsg += `Insufficient balance for ${lType}. Requested: ${daysNeeded}, Available: ${available}.<br>`;
            }
          }
        }

        if (errorMsg) {
          loadingScreen.style.display = "none";
          resultBody.innerHTML = `<div class="alert alert-warning">${errorMsg}</div>`;
          resultModal.show();
          submitBtn.disabled = false;
          return;
        }

        // Process Files and Submit
        processSubmissionFinal(requestsRequests, balance);
      })
      .withFailureHandler(err => {
        loadError(err);
      })
      .getLeaveBalanceByEmail(email);

    function loadError(e) {
      loadingScreen.style.display = "none";
      submitBtn.disabled = false;
      showModal("System Error", "Error: " + e, true);
    }

    async function processSubmissionFinal(requestsData, balanceInfo) {
      // Helper to read file
      const readFile = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve({
          name: file.name,
          mimeType: file.type,
          content: e.target.result.split(',')[1]
        });
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      // Prepare data with files
      const finalRequests = [];
      try {
        for (const req of requestsData) {
          let fileData = null;
          if (req.fileInput) {
            fileData = await readFile(req.fileInput);
          }
          // Construct Clean Object for Backend
          finalRequests.push({
            leaveType: req.leaveType,
            startDate: req.startDate,
            endDate: req.endDate,
            reason: req.reason,
            duration: req.duration,
            fileData: fileData // Attach file data specifically to this request
          });
        }

        // Send to Backend
        google.script.run
          .withSuccessHandler((res) => {
            loadingScreen.style.display = "none";
            if (res === 'Success') {
              showSuccessModal(balanceInfo);
            } else {
              resultBody.innerHTML = `<div class="alert alert-danger">${res}</div>`;
              resultModal.show();
              submitBtn.disabled = false;
            }
          })
          .withFailureHandler(loadError)
          .submitRequest(name, email, department, finalRequests, null, null, null, null); // Pass array, null for legacy file

      } catch (err) {
        loadError("File processing error: " + err);
      }
    }

    function showSuccessModal(balanceInfo) {
      const balanceContent = balanceInfo ? `
         <p class="mb-2">Your current leave balance:</p>
         <ul class="list-group list-group-flush text-start small mb-3">
           <li class="list-group-item d-flex justify-content-between py-1"><span>Annual:</span> <strong>${balanceInfo.annual}</strong></li>
           <li class="list-group-item d-flex justify-content-between py-1"><span>Sick:</span> <strong>${balanceInfo.sick}</strong></li>
           ${parseFloat(balanceInfo.bereavement) > 0 ? `<li class="list-group-item d-flex justify-content-between py-1"><span>Bereavement:</span> <strong>${balanceInfo.bereavement}</strong></li>` : ''}
           ${parseFloat(balanceInfo.marriage) > 0 ? `<li class="list-group-item d-flex justify-content-between py-1"><span>Marriage:</span> <strong>${balanceInfo.marriage}</strong></li>` : ''}
           ${parseFloat(balanceInfo.maternity) > 0 ? `<li class="list-group-item d-flex justify-content-between py-1"><span>Maternity:</span> <strong>${balanceInfo.maternity}</strong></li>` : ''}
         </ul>` : `<p class="text-muted">No balance check required for this leave type.</p>`;

      resultBody.innerHTML = `
        <div class="alert alert-success border-0 shadow-sm">
          <h4 class="alert-heading"><i class="bi bi-check-circle-fill me-2"></i>Request Submitted!</h4>
          <p>Your requests have been queued for approval.</p>
          <hr>
          <div class="mb-3">
             <strong>${escapeHtml(name)}</strong><br>
             <span class="text-muted">${escapeHtml(email)}</span>
          </div>
          ${balanceContent}
          <div class="alert alert-light border mt-3 small text-muted">
             <i class="bi bi-info-circle me-1"></i> <strong>Note:</strong> If your remaining leave balance is insufficient, the request will be automatically rejected.
          </div>
        </div>`;

      modalFooter.innerHTML = `
        <button type="button" class="btn btn-outline-info" id="newFormBtn"><i class="bi bi-plus-lg me-1"></i> Make a New Request</button>
        <button type="button" class="btn btn-outline-danger" id="closeTabBtn"><i class="bi bi-x-lg me-1"></i> Close This Tab</button>`;

      resultModal.show();
      submitBtn.innerText = "Success ðŸŽ‰";
      isSuccess = true;

      setTimeout(() => {
        document.getElementById("newFormBtn").addEventListener("click", () => {
          document.getElementById("leaveForm").reset();
          submitBtn.disabled = false;
          submitBtn.innerText = "Submit Request";
          resultModal.hide();
        });

        document.getElementById("closeTabBtn").addEventListener("click", () => {
          // Attempt to close
          try { window.open('', '_self').close(); } catch (e) { }

          // Show message because scripts often cannot close tabs they didn't open
          resultBody.innerHTML = `
            <div class="alert alert-success border-0 shadow-sm text-center">
               <h4 class="alert-heading">Request Submitted!</h4>
               <p class="mb-3">Thank you for your submission.</p>
               <div class="alert alert-warning small">
                 <strong>Note:</strong> Browser security often prevents websites from closing tabs automatically.
               </div>
               <p>You may safely close this tab or window now.</p>
               <a href="https://google.com" class="btn btn-sm btn-outline-secondary mt-2">Go to Google</a>
            </div>`;
          modalFooter.innerHTML = '';
        });
      }, 100);
    }

  });
</script>

<!-- Here list of my nice music
  1. B4VJiK8x_fY - Point_Black
  2. bHe_i98krmo - Carol of the bells
  3. eaAjP_4Gcnk - Song of the North
  4. tGdS9vc8T_I - Chinmoku no Majo
  5. D4clzuenBmc - Dance with the Trees
  6. CdSviNVPzYo - The last of the Mohicans
  7. nHPK2gZQwM8 - Genshin - Mondstadt Night
  8. hFKF2b8yX7o - Skyrim Secunda
  -->
<!-- <script>
  
  let player;
  let userInteracted = false;

  function onYouTubeIframeAPIReady() {
    player = new YT.Player('musicPlayer', {
      height: '0',
      width: '0',
      videoId: 'tGdS9vc8T_I', // YouTube ID only
      playerVars: {
        autoplay: 1,
        loop: 1,
        playlist: 'tGdS9vc8T_I,hFKF2b8yX7o,nHPK2gZQwM8', // List of video IDs for looping
        controls: 0,
        disablekb: 1,
        fs: 0,
        modestbranding: 1
      },
      events: {
        onReady: event => {
          event.target.playVideo();
          event.target.mute(); // Must start muted to allow autoplay
          event.target.setPlaybackQuality('tiny'); // Reduce quality for performance
        }
      }
    });
  }

  // Unmute after first click
  document.addEventListener("click", () => {
    if (!userInteracted && player) {
      player.unMute();
      player.setVolume(10); // adjust volume 0-100
      userInteracted = true;
    }
  });
</script>

<script>
    const toggleBtn = document.getElementById("toggleMusic");

    toggleBtn.addEventListener("click", () => {
        if (player.isMuted()) {
            player.unMute();
            toggleBtn.textContent = "ðŸ”Š Playing";
        } else {
            player.mute();
            toggleBtn.textContent = "ðŸ”ˆ Muted";
        }
    });
</script>

<script src="https://www.youtube.com/iframe_api"></script> -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Initialize Bootstrap Popovers
  const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
  const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl));
</script>
</body>

</html>